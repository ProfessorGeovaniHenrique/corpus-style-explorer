name: Recover Stalled Enrichment Jobs

on:
  schedule:
    # SPRINT ENRICHMENT-AUTO-RESUME: Reduzido de 10 para 3 minutos
    - cron: '*/3 * * * *'
  workflow_dispatch:

env:
  SUPABASE_PROJECT_REF: kywmhuubbsvclkorxrse
  SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

jobs:
  recover-enrichment-jobs:
    runs-on: ubuntu-latest
    steps:
      - name: Check for stalled enrichment jobs
        run: |
          set -e
          echo "üîÑ Checking for stalled enrichment jobs at $(date -u)"
          
          # Primeiro: Limpar jobs com is_cancelling=true h√° mais de 3 minutos (reduzido de 5)
          echo "üßπ Cleaning up stuck cancellation requests..."
          cancel_cleanup=$(curl -s -X PATCH \
            "https://${SUPABASE_PROJECT_REF}.supabase.co/rest/v1/enrichment_jobs?is_cancelling=eq.true&status=eq.processando&last_chunk_at=lt.$(date -u -d '3 minutes ago' +%Y-%m-%dT%H:%M:%SZ)" \
            -H "apikey: $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=representation" \
            -d '{"status": "cancelado", "tempo_fim": "'"$(date -u +%Y-%m-%dT%H:%M:%SZ)"'", "is_cancelling": false}')
          
          cleaned_count=$(echo "$cancel_cleanup" | jq 'length // 0')
          if [ "$cleaned_count" != "0" ] && [ "$cleaned_count" != "null" ]; then
            echo "‚úÖ Cleaned up $cleaned_count stuck cancellation jobs"
          fi
          
          # SPRINT ENRICHMENT-AUTO-RESUME: Buscar jobs pausados para retomar automaticamente
          echo "üîç Looking for paused jobs to auto-resume..."
          paused_jobs=$(curl -s \
            "https://${SUPABASE_PROJECT_REF}.supabase.co/rest/v1/enrichment_jobs?status=eq.pausado&last_chunk_at=lt.$(date -u -d '2 minutes ago' +%Y-%m-%dT%H:%M:%SZ)&select=id,status,job_type,current_song_index,total_songs,erro_mensagem" \
            -H "apikey: $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY")
          
          paused_count=$(echo "$paused_jobs" | jq 'length')
          
          if [ "$paused_count" != "0" ] && [ "$paused_count" != "null" ]; then
            echo "‚è∏Ô∏è Found $paused_count paused job(s) to resume"
            
            echo "$paused_jobs" | jq -c '.[]' | while read job; do
              job_id=$(echo $job | jq -r '.id')
              song_index=$(echo $job | jq -r '.current_song_index')
              erro=$(echo $job | jq -r '.erro_mensagem // ""')
              
              # N√£o retomar se for circuit breaker
              if echo "$erro" | grep -qi "circuit breaker"; then
                echo "‚è≠Ô∏è Skipping job $job_id (circuit breaker)"
                continue
              fi
              
              echo "‚ñ∂Ô∏è Auto-resuming paused job $job_id (index: $song_index)"
              
              response=$(curl -s -w "\n%{http_code}" -X POST "https://${SUPABASE_PROJECT_REF}.supabase.co/functions/v1/enrich-songs-batch" \
                -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
                -H "Content-Type: application/json" \
                -d "{\"jobId\": \"$job_id\", \"continueFrom\": $song_index}")
              
              http_code=$(echo "$response" | tail -n1)
              
              if [ "$http_code" = "200" ]; then
                echo "‚úÖ Paused job $job_id resumed successfully"
              else
                echo "‚ö†Ô∏è Failed to resume paused job $job_id (HTTP $http_code)"
              fi
              
              sleep 2
            done
          fi
          
          # Buscar jobs travados (processando sem heartbeat h√° mais de 3 minutos) - USANDO last_chunk_at
          stalled_jobs=$(curl -s \
            "https://${SUPABASE_PROJECT_REF}.supabase.co/rest/v1/enrichment_jobs?status=in.(processando,pendente)&last_chunk_at=lt.$(date -u -d '3 minutes ago' +%Y-%m-%dT%H:%M:%SZ)&select=id,status,job_type,current_song_index,total_songs,is_cancelling" \
            -H "apikey: $SUPABASE_SERVICE_ROLE_KEY" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY")
          
          job_count=$(echo "$stalled_jobs" | jq 'length')
          
          if [ "$job_count" = "0" ] || [ "$job_count" = "null" ]; then
            echo "‚úÖ No stalled enrichment jobs found"
            exit 0
          fi
          
          echo "‚ö†Ô∏è Found $job_count stalled enrichment job(s)"
          
          echo "$stalled_jobs" | jq -c '.[]' | while read job; do
            job_id=$(echo $job | jq -r '.id')
            song_index=$(echo $job | jq -r '.current_song_index')
            total_songs=$(echo $job | jq -r '.total_songs')
            status=$(echo $job | jq -r '.status')
            job_type=$(echo $job | jq -r '.job_type')
            is_cancelling=$(echo $job | jq -r '.is_cancelling')
            
            if [ "$is_cancelling" = "true" ]; then
              echo "‚è≠Ô∏è Skipping job $job_id (is_cancelling=true)"
              continue
            fi
            
            echo "üîÑ Resuming stalled job $job_id (type: $job_type, status: $status, progress: $song_index/$total_songs)"
            
            response=$(curl -s -w "\n%{http_code}" -X POST "https://${SUPABASE_PROJECT_REF}.supabase.co/functions/v1/enrich-songs-batch" \
              -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
              -H "Content-Type: application/json" \
              -d "{\"jobId\": \"$job_id\", \"continueFrom\": $song_index, \"forceLock\": true}")
            
            http_code=$(echo "$response" | tail -n1)
            body=$(echo "$response" | sed '$d')
            
            if [ "$http_code" = "200" ]; then
              echo "‚úÖ Enrichment job $job_id resumed successfully"
            else
              echo "‚ùå Failed to resume enrichment job $job_id (HTTP $http_code)"
              echo "Response: $body"
            fi
            
            sleep 2
          done
          
          echo "üèÅ Enrichment job recovery check complete"
