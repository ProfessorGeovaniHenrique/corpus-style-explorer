name: ğŸš€ Pre-Deployment Check

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  quality-gate:
    name: ğŸš¦ Quality Gate
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“š Instalar dependÃªncias
        run: npm ci

      - name: ğŸ” Verificar tipos TypeScript
        run: npm run typecheck || echo "::warning::Erros de tipagem encontrados"

      - name: ğŸ§ª Executar testes do corpus
        id: corpus-tests
        run: npm run test:corpus
        continue-on-error: false

      - name: ğŸ“Š Gerar relatÃ³rio HTML
        if: always()
        run: npm run test:corpus:report-html

      - name: ğŸ“¤ Publicar relatÃ³rio como artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-report
          path: test-reports/

      - name: ğŸ’¬ Comentar no PR com resultados
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(
              fs.readFileSync('test-reports/corpus-integrity-latest.json', 'utf8')
            );
            
            const status = report.summary.failed > 0 ? 'âŒ' : 
                          report.summary.warnings > 0 ? 'âš ï¸' : 'âœ…';
            
            const body = `## ${status} Resultados dos Testes de Integridade do Corpus
            
            **Status:** ${report.summary.status.toUpperCase()}
            
            | MÃ©trica | Valor |
            |---------|-------|
            | Total de testes | ${report.summary.totalTests} |
            | âœ… Passaram | ${report.summary.passed} |
            | âŒ Falharam | ${report.summary.failed} |
            | âš ï¸ Avisos | ${report.summary.warnings} |
            
            ${report.summary.failed > 0 ? '**âš ï¸ Deploy bloqueado devido a falhas nos testes!**' : ''}
            ${report.summary.warnings > 0 ? '**â„¹ï¸ Existem avisos que devem ser revisados.**' : ''}
            
            [Ver relatÃ³rio completo nos artifacts](https://github.com/${{github.repository}}/actions/runs/${{github.run_id}})
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: âŒ Falhar se testes crÃ­ticos falharam
        if: failure()
        run: |
          echo "::error::ğŸš« DEPLOY BLOQUEADO!"
          echo "::error::Os testes de integridade do corpus falharam."
          echo "::error::Corrija os problemas antes de fazer merge/deploy."
          exit 1

      - name: âœ… Aprovar para deploy
        if: success()
        run: |
          echo "::notice::âœ… Quality Gate passou!"
          echo "::notice::Corpus validado - Deploy autorizado"

  notify-status:
    name: ğŸ“¢ Notificar Status
    runs-on: ubuntu-latest
    needs: quality-gate
    if: always()
    
    steps:
      - name: ğŸ“Š Status final
        run: |
          if [ "${{ needs.quality-gate.result }}" == "success" ]; then
            echo "âœ… Todos os checks passaram - Deploy pode prosseguir"
          else
            echo "âŒ Checks falharam - Deploy bloqueado"
          fi
