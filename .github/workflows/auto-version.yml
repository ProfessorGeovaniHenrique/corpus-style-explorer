name: üî¢ Auto Version

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (n√£o cria tag)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write

jobs:
  version:
    name: üì¶ Calcular e Atualizar Vers√£o
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.bump.outputs.version }}
      previous_version: ${{ steps.bump.outputs.previous_version }}
      bump_type: ${{ steps.bump.outputs.bump_type }}
      
    steps:
      - name: üì• Checkout do c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Necess√°rio para acessar hist√≥rico completo
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üì¶ Instalar depend√™ncias
        run: npm ci

      - name: üî¢ Executar bump de vers√£o
        id: bump
        run: |
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            npm run version:bump -- --dry-run
          else
            npm run version:bump -- --tag
          fi
        env:
          CI: true

      - name: üìù Gerar/Atualizar Changelog
        if: steps.bump.outputs.version != ''
        run: |
          if [ -f "CHANGELOG.md" ]; then
            echo "Atualizando CHANGELOG.md existente..."
            npm run changelog:update -- --version v${{ steps.bump.outputs.version }}
          else
            echo "Gerando CHANGELOG.md inicial..."
            npm run changelog:generate
          fi

      - name: üìù Commit e Push da nova vers√£o
        if: steps.bump.outputs.version != ''
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add VERSION CHANGELOG.md
          git commit -m "chore: bump version to ${{ steps.bump.outputs.version }}"
          git push
          
          # Push tags
          git push --tags
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: üìä Resumo da vers√£o
        if: steps.bump.outputs.version != ''
        run: |
          echo "## üéâ Nova Vers√£o Publicada" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Vers√£o Anterior:** ${{ steps.bump.outputs.previous_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Nova Vers√£o:** ${{ steps.bump.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tipo de Bump:** ${{ steps.bump.outputs.bump_type }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üè∑Ô∏è Tag \`v${{ steps.bump.outputs.version }}\` criada e enviada ao GitHub" >> $GITHUB_STEP_SUMMARY
          echo "üìù CHANGELOG.md atualizado" >> $GITHUB_STEP_SUMMARY

  create-release:
    name: üìù Criar GitHub Release
    needs: version
    runs-on: ubuntu-latest
    if: needs.version.outputs.new_version != ''
    
    steps:
      - name: üì• Checkout do c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üì• Checkout do c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: üì¶ Instalar depend√™ncias
        run: npm ci

      - name: üìù Extrair notas de release do CHANGELOG
        id: release_notes
        run: |
          # Gerar changelog para esta vers√£o espec√≠fica
          NOTES=$(npm run changelog:generate -- --version v${{ needs.version.outputs.new_version }} 2>/dev/null | tail -n +3)
          
          if [ -z "$NOTES" ]; then
            # Fallback para m√©todo antigo
            PREVIOUS_TAG="v${{ needs.version.outputs.previous_version }}"
            NEW_TAG="v${{ needs.version.outputs.new_version }}"
            
            CHANGELOG=$(git log $PREVIOUS_TAG..$NEW_TAG --pretty=format:"- %s (%h)" --no-merges)
            
            FEATURES=$(echo "$CHANGELOG" | grep "^- feat" || echo "")
            FIXES=$(echo "$CHANGELOG" | grep "^- fix" || echo "")
            BREAKING=$(echo "$CHANGELOG" | grep "BREAKING" || echo "")
            
            NOTES="## üéâ Release $NEW_TAG\n\n"
            
            if [ -n "$BREAKING" ]; then
              NOTES="$NOTES### üí• Breaking Changes\n$BREAKING\n\n"
            fi
            
            if [ -n "$FEATURES" ]; then
              NOTES="$NOTES### ‚ú® Features\n$FEATURES\n\n"
            fi
            
            if [ -n "$FIXES" ]; then
              NOTES="$NOTES### üêõ Bug Fixes\n$FIXES"
            fi
          fi
          
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo -e "$NOTES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: üöÄ Criar GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ needs.version.outputs.new_version }}
          release_name: Release v${{ needs.version.outputs.new_version }}
          body: ${{ steps.release_notes.outputs.notes }}
          draft: false
          prerelease: ${{ needs.version.outputs.bump_type == 'major' && contains(needs.version.outputs.new_version, '0.') }}
